# SMC观众投票反演系统

## 概述

本系统使用**序贯蒙特卡洛（Sequential Monte Carlo, SMC）/ 粒子滤波（Particle Filter）**算法，从裁判打分和淘汰结果反向推算每位选手每周的观众支持率。

## 核心算法

### 1. 粒子滤波框架

系统使用5000个粒子来表示观众投票分布的可能状态空间。每个粒子代表一种"可能的观众投票分布"。

### 2. 算法流程

#### 初始化（Week 1）
- 使用Dirichlet分布初始化粒子
- 假设所有选手的初始人气相对均匀

#### 时间推进（Week by Week）

**步骤A：预测（Predict）**
- 添加高斯噪声模拟人气波动：`New_Particle = Old_Particle + N(0, 0.05)`
- 重新归一化确保投票总和为1

**步骤B：更新（Update）**
- 根据真实淘汰结果计算粒子权重
- 规则分流：
  - Season 1-2：排名制（Rank-based）
  - Season 3+：百分比制（Percentage-based）
- 软约束策略：使用指数衰减权重 `exp(-α * rank_diff)`

**步骤C：重采样（Resample）**
- 根据权重重采样粒子
- 急救机制：当所有粒子权重为0时重新初始化

### 3. 淘汰规则

#### 排名制（Season 1-2）
```
总排名 = 裁判排名 + 观众排名
淘汰者 = 总排名最大（最差）的选手
```

#### 百分比制（Season 3+）
```
总百分比 = 裁判分数占比 + 观众投票占比
淘汰者 = 总百分比最低的选手
```

## 输出文件

### Q1_Estimated_Fan_Votes.csv

包含以下字段：

| 字段 | 说明 |
|------|------|
| Season | 赛季编号 |
| Week | 周次（1-11） |
| Name | 选手姓名 |
| Estimated_Fan_Vote | 估计的观众投票占比（0-1之间） |
| Uncertainty_Std | 投票估计的不确定性（标准差） |
| Rule_Used | 使用的规则（rank或percent） |

## 使用方法

### 运行主程序

```bash
python src/smc_fan_vote_estimator.py
```

### 验证结果

```bash
python verify_results.py
```

## 结果验证

### 1. 投票总和验证
每周所有选手的 `Estimated_Fan_Vote` 总和应该等于 1.0（100%）

实际结果：
- 平均值：1.000000
- 标准差：0.000000
- ✓ 所有周次都完美归一化

### 2. 不确定性统计

- 平均不确定性：0.085393
- 中位数：0.085117
- 范围：0.003550 - 0.215512

不确定性较高的情况通常出现在：
- 决赛阶段（选手较少）
- 竞争激烈的周次
- 排名制赛季（规则更复杂）

### 3. 规则对比

| 规则 | 赛季数 | 数据行数 | 平均不确定性 |
|------|--------|----------|--------------|
| Rank | 2 | 78 | 0.116291 |
| Percent | 32 | 2699 | 0.084500 |

排名制的不确定性更高，因为排名转换引入了额外的非线性。

## 算法参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| n_particles | 5000 | 粒子数量 |
| noise_std | 0.05 | 随机游走噪声标准差 |
| alpha | 2.0 | 软约束指数衰减参数 |

## 性能优化

- 使用NumPy矩阵运算加速计算
- 避免Python原生循环
- 5000个粒子 × 34个赛季 × 平均8周 ≈ 136万次粒子更新
- 总运行时间：约30-60秒

## 技术栈

- **Python 3.8+**
- **NumPy**: 高性能数值计算
- **Pandas**: 数据处理
- **正则表达式**: 淘汰信息提取

## 理论基础

### 贝叶斯滤波
SMC是贝叶斯滤波的一种实现方法，通过粒子近似后验分布：

```
p(x_t | y_{1:t}) ≈ Σ w_i^t δ(x_t - x_i^t)
```

其中：
- `x_t`: 第t周的观众投票状态
- `y_{1:t}`: 第1周到第t周的观测（裁判分数+淘汰结果）
- `w_i^t`: 第i个粒子的权重
- `x_i^t`: 第i个粒子的状态

### 重要性采样
权重更新使用重要性采样：

```
w_i^t ∝ p(y_t | x_i^t) * w_i^{t-1}
```

### 软约束策略
为了提高鲁棒性，使用软约束而非硬约束：

```
w_i = exp(-α * rank_diff)
```

这允许模型容忍一定程度的预测误差。

## 注意事项

1. **数据质量**：结果依赖于输入数据的准确性
2. **模型假设**：假设观众投票相对稳定，只有小幅波动
3. **淘汰规则**：必须正确识别每个赛季的淘汰规则
4. **计算资源**：粒子数量越多，结果越准确，但计算时间越长

## Q2答案

**不确定性（Uncertainty_Std）**字段直接回答了Q2的问题：

- 该值表示观众投票估计的标准差
- 值越大，表示估计的不确定性越高
- 可用于构建置信区间：`[mean - 2*std, mean + 2*std]`

## 未来改进方向

1. **自适应粒子数**：根据不确定性动态调整粒子数量
2. **更复杂的转移模型**：考虑选手表现对人气的影响
3. **多模态分布**：使用混合模型处理复杂情况
4. **在线学习**：根据历史数据优化参数

## 参考文献

- Doucet, A., & Johansen, A. M. (2009). A tutorial on particle filtering and smoothing.
- Arulampalam, M. S., et al. (2002). A tutorial on particle filters for online nonlinear/non-Gaussian Bayesian tracking.
